# Логика Snapshot-ов Туров

## Концепция

Каждый тур хранит **исторический snapshot** состава команды пользователя на момент дедлайна этого тура. Это обеспечивает **историческую целостность** данных.

## Базовые Принципы

### 1. Независимость туров
- Каждый `SquadTour` является независимым snapshot-состоянием
- Изменения в будущих турах **не влияют** на прошлые туры
- История туров **не изменяется** при последующих трансферах

### 2. Что хранится в snapshot
Каждый `SquadTour` содержит:
- `tour_id` - ID тура
- `squad_id` - ID сквада
- `points` - очки, заработанные в этом туре
- `captain_id` - капитан на момент тура
- `vice_captain_id` - вице-капитан на момент тура
- `main_players` - список игроков основного состава (11 игроков)
- `bench_players` - список игроков на скамейке (4 игрока)
- `used_boost` - использованный буст (если был)
- `is_current` - флаг текущего тура

## Жизненный Цикл Snapshot-а

### 1. Создание сквада
При создании сквада (`SquadService.create_squad`):
- Определяется активный тур (текущий или следующий)
- Создается `SquadTour` для этого тура с начальным составом
- `is_current = True`

### 2. Изменение состава
При обновлении игроков (`update_squad_players` или `replace_players`):
- Обновляется **только текущий состав** в таблице `Squad`
- Вызывается `_save_current_squad()`, который:
  - Находит или создает `SquadTour` для текущего тура (`squad.current_tour_id`)
  - Обновляет snapshot с новым составом
  - **НЕ трогает** прошлые туры

### 3. Переход к следующему туру
⚠️ **ВАЖНО**: Необходимо реализовать механизм смены туров!

При переходе к новому туру должно происходить:
1. Завершение текущего `SquadTour`:
   - `is_current = False`
   - Финальный подсчет очков тура
2. Создание нового `SquadTour`:
   - Копирование текущего состава из `Squad`
   - `is_current = True`
   - Обновление `Squad.current_tour_id`

## Логика Начисления Очков

### По турам
- Очки начисляются **только игрокам в основном составе** на момент тура
- Игроки на скамейке не получают очки (без активации буста)
- Очки сохраняются в `SquadTour.points`

### При трансферах
- Если игрок был **продан**: его очки за прошлые туры остаются в истории
- Если игрок был **куплен**: его очки начинают начисляться со следующего тура, в котором он в основе

## Отображение Истории

### API Endpoint
`GET /squads/{squad_id}/history`

Возвращает список `SquadTourHistorySchema` с полной информацией:
- Данные тура (ID, номер, очки)
- Капитан и вице-капитан на тот момент
- Полный список игроков основы с их очками за тур
- Полный список игроков скамейки с их очками за тур

### Пример Сценария

**Тур 3:**
- Состав: [Игрок A, Игрок B, Игрок C, ...]
- Очки тура: 50
- **Snapshot зафиксирован**

**Тур 4 (после трансфера):**
- Пользователь продал Игрока B, купил Игрока D
- Новый состав: [Игрок A, Игрок D, Игрок C, ...]
- Очки тура: 45

**При просмотре истории:**
- История Тура 3: показывает [Игрок A, Игрок B, Игрок C, ...] с 50 очками
- История Тура 4: показывает [Игрок A, Игрок D, Игрок C, ...] с 45 очками

## Реализация

### Модели
- `Squad` - текущее состояние сквада
- `SquadTour` - исторический snapshot тура

### Ассоциативные Таблицы
- `squad_tour_players` - игроки основы в туре
- `squad_tour_bench_players` - игроки скамейки в туре

### Ключевые Методы
- `SquadService._save_current_squad()` - сохраняет snapshot текущего состава
- `SquadService.get_squad_tour_history_with_players()` - загружает полную историю
- `SquadService.update_squad_players()` - обновляет состав
- `SquadService.replace_players()` - замена игроков (трансферы)

## TODO: Автоматизация Смены Туров

Необходимо реализовать:

1. **Cron-задача или фоновый процесс**, который:
   - Отслеживает дедлайны туров
   - При наступлении дедлайна:
     - Финализирует все `SquadTour` с `is_current=True`
     - Создает новые `SquadTour` для следующего тура
     - Обновляет `Squad.current_tour_id`

2. **API endpoint** для ручной смены тура (для админа):
   ```
   POST /tours/{tour_id}/finalize
   ```

3. **Обработка edge cases**:
   - Первый тур сезона
   - Последний тур сезона
   - Пропущенные туры (если пользователь не заходил)

## Инварианты Системы

✅ **Прошлые туры никогда не изменяются**
✅ **Каждый тур хранит свой snapshot**
✅ **История туров независима от текущего состава**
✅ **Трансферы влияют только на текущий/будущий тур**

## Тестирование

Для проверки корректности работы:

1. Создать сквад в Туре 1
2. Завершить Тур 1, перейти к Туру 2
3. Сделать трансферы перед Туром 2
4. Проверить историю - Тур 1 должен показывать старый состав
5. Завершить Тур 2, перейти к Туру 3
6. Сделать еще трансферы
7. Проверить историю - Туры 1 и 2 не должны измениться
